<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Widener's Recipe Vault</title>
    <style>
        :root { --primary: #c62828; --secondary: #2e7d32; --dark: #c62828; --light: #f4f7f6; --accent: #1565c0; --pizza-bg: #e8f4f8; --pizza-border: #d1e7ef; --orange-accent: #e25822; --orange-bg: #fff3e0; }
        body { font-family: -apple-system, system-ui, sans-serif; line-height: 1.5; color: #333; margin: 0; background-color: var(--light); display: flex; flex-direction: column; min-height: 100vh; }
        header { background: var(--dark); color: white; padding: 1rem 2rem; display: flex; align-items: center; gap: 15px; z-index: 10; }
        header h1 { margin: 0; flex: 1; text-align: right; font-size: 1.5rem; }
        
        .main-layout { display: flex; flex: 1; position: relative; width: 100%; justify-content: center; }
        .container { flex: 1; max-width: 900px; padding: 20px; }
        
        /* Grid Styles */
        .grid-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-top: 20px; }
        
        /* Cards */
        .card-base { background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 10px rgba(0,0,0,0.1); cursor: pointer; border: 1px solid #ddd; transition: transform 0.2s; padding: 20px; }
        .card-base:hover { transform: translateY(-3px); }
        .card-base h3 { margin: 0 0 10px 0; color: var(--primary); }

        /* Category Card Specifics */
        .cat-card { text-align: center; border-left: 5px solid var(--accent); }
        .cat-card h3 { font-size: 1.4em; color: var(--accent); margin-bottom: 5px; }
        .cat-count { color: #666; font-size: 0.9em; }

        /* Recipe Card Specifics */
        .recipe-card { border-left: 5px solid var(--primary); }

        /* Controls */
        .view-hidden { display: none !important; }
        .nav-btn { background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.4); padding: 8px 15px; border-radius: 6px; font-weight: bold; cursor: pointer; transition: background 0.2s; text-decoration: none; display: inline-flex; align-items: center; font-size: 0.9em; }
        .nav-btn:hover { background: rgba(255,255,255,0.3); }
        
        .card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .pizza-main-box { background: var(--pizza-bg); padding: 25px; border-radius: 10px; border: 1px solid var(--pizza-border); margin-bottom: 20px; }
        .pan-row { background: var(--orange-bg); border: 1px solid #ffcc80; border-left: 6px solid var(--orange-accent); padding: 20px; border-radius: 8px; margin-top: 15px; display: flex; flex-wrap: wrap; gap: 20px; align-items: center; justify-content: space-between; }
        .pan-field { display: flex; flex-direction: column; gap: 8px; flex: 1; min-width: 100px; }
        .pan-field label { font-size: 0.9em; font-weight: bold; color: #5d4037; text-transform: uppercase; letter-spacing: 0.5px; }
        .pan-field input, .pan-field select { padding: 10px; font-size: 1rem; border: 1px solid #ffb74d; border-radius: 6px; background: #fff; }
        .stepper-box { background: #fff8e1; padding: 20px; border-radius: 8px; border: 1px solid #ffd54f; margin-bottom: 20px; }
        .stepper { display: flex; align-items: center; gap: 20px; margin-top: 10px; }
        .btn-step { background: var(--dark); color: white; border: none; width: 45px; height: 45px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; }
        .summary-bar { background: var(--dark); color: white; padding: 20px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; font-size: 1.1em; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { text-align: left; padding: 12px; border-bottom: 1px solid #eee; }
        .method-box { background: white; padding: 25px; border-radius: 12px; border-left: 8px solid var(--secondary); white-space: pre-wrap; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .link-btn { background: var(--accent); color: white; border: none; padding: 10px 15px; border-radius: 4px; cursor: pointer; margin-top: 15px; font-weight: bold; }
        .remove-btn { background: #d32f2f; color: white; border: none; border-radius: 4px; padding: 8px; cursor: pointer; align-self: flex-end; margin-bottom: 2px; }

        /* Search Bar Styles */
        .search-container { position: relative; margin-bottom: 20px; width: 100%; max-width: 400px; }
        #recipe-search { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #ddd; font-size: 1rem; box-sizing: border-box; }
        .search-results { 
            position: absolute; top: 100%; left: 0; right: 0; 
            background: white; border: 1px solid #ddd; border-top: none; 
            border-radius: 0 0 8px 8px; z-index: 1000; max-height: 300px; 
            overflow-y: auto; box-shadow: 0 4px 10px rgba(0,0,0,0.1); 
        }
        .search-item { padding: 10px 15px; cursor: pointer; border-bottom: 1px solid #eee; }
        .search-item:last-child { border-bottom: none; }
        .search-item:hover { background-color: #f0f0f0; }
        .search-item .item-name { font-weight: bold; color: var(--primary); display: block; }
        .search-item .item-cat { font-size: 0.8rem; color: #777; }
    </style>
</head>
<body>

<header>
    <div id="nav-container" style="display:flex; gap:10px;">
        </div>
    <h1>Widener's Recipe Vault</h1>
</header>

<div class="main-layout">
    <div class="container">
        
        <div id="home-view">
            <div class="search-container">
                <input type="text" id="recipe-search" placeholder="Search recipes..." oninput="filterRecipes(this.value)">
                <div id="search-dropdown" class="search-results view-hidden"></div>
            </div>

            <h2 style="border-bottom: 2px solid #ddd; padding-bottom:10px; color: #555;">Categories</h2>
            <div class="grid-container" id="category-list"></div>
        </div>

        <div id="category-view" class="view-hidden">
            <h2 id="cat-title" style="border-bottom: 2px solid #ddd; padding-bottom:10px; color: #555;">Category</h2>
            <div class="grid-container" id="recipe-list"></div>
        </div>

        <div id="calc-view" class="view-hidden">
            <div class="card">
                <h2 id="recipe-name" style="margin:0; color:var(--primary);"></h2>
                <p id="recipe-desc" style="color:#666; margin-bottom:15px;"></p>
                <div id="pizza-controls" class="pizza-main-box hidden">
                    <div style="margin-bottom: 20px; padding: 12px; background: rgba(255,255,255,0.5); border-radius: 6px; border: 1px dashed var(--accent);">
                        <input type="checkbox" id="isFreshMilled" onchange="calculate()"> 
                        <label for="isFreshMilled" style="font-weight:bold; cursor:pointer; color: var(--accent); font-size: 1.1em;">Fresh Milled Flour (+5% Liquids)</label>
                    </div>
                    <div id="pan-container"></div>
                    <div style="text-align: right; margin-top: 20px;">
                        <button onclick="addPan()" style="background:var(--orange-accent); color:white; border:none; padding:12px 20px; border-radius:6px; font-weight:bold; cursor:pointer;">+ ADD ANOTHER PAN</button>
                    </div>
                </div>
                <div id="standard-controls" class="stepper-box hidden">
                    <label style="font-weight:bold;">Adjust Batch Size</label>
                    <div class="stepper">
                        <button class="btn-step" onclick="changeBatch(-0.5)">−</button>
                        <span id="batch-val" style="font-size:1.5rem; font-weight:bold; min-width:60px; text-align:center;">1.0</span>
                        <button class="btn-step" onclick="changeBatch(0.5)">+</button>
                    </div>
                </div>
                <div class="summary-bar">
                    <div>Scaling Factor: <span id="factor-display" style="color:#ffca28; font-weight:bold;">1.00x</span></div>
                    <div>Total Weight: <span id="grand-total" style="color:#ffca28; font-weight:bold;">0</span>g</div>
                </div>
                <table>
                    <thead><tr><th>Ingredient</th><th>Grams / Qty</th><th>Measure</th></tr></thead>
                    <tbody id="ingredient-body"></tbody>
                </table>
            </div>
            <div class="method-box">
                <h3 style="margin-top:0;">Instructions</h3>
                <div id="method-text"></div>
                <div id="recipe-link-container"></div>
            </div>
        </div>
    </div>
</div>
<script type="text/javascript" src = "./recipes.js"></script>
<script>

    let currentRecipe = null;
    let currentCategory = null;
    let currentBatchScale = 1.0;
    let pans = [{ id: 1, shape: 'rect', dim1: 10, dim2: 8, qty: 1 }];

    function init() {
        const homeView = document.getElementById('category-list');
        homeView.innerHTML = '';
        
        // Extract unique categories
        const categories = [...new Set(recipes.map(r => r.category || "Uncategorized"))].sort();

        categories.forEach(cat => {
            const count = recipes.filter(r => (r.category || "Uncategorized") === cat).length;
            const card = document.createElement('div');
            card.className = 'card-base cat-card';
            card.innerHTML = `<h3>${cat}</h3><div class="cat-count">${count} Recipe${count !== 1 ? 's' : ''}</div>`;
            card.onclick = () => loadCategory(cat);
            homeView.appendChild(card);
        });

        showHome();
    }

    // Search Functionality
    function filterRecipes(query) {
        const dropdown = document.getElementById('search-dropdown');
        const searchTerm = query.toLowerCase().trim();

        if (searchTerm.length < 1) {
            dropdown.classList.add('view-hidden');
            return;
        }

        const matches = recipes.filter(r => 
            r.name.toLowerCase().includes(searchTerm) || 
            (r.category && r.category.toLowerCase().includes(searchTerm))
        );

        if (matches.length > 0) {
            dropdown.innerHTML = matches.map(r => `
                <div class="search-item" onclick="selectSearchResult('${r.id}', '${r.category}')">
                    <span class="item-name">${r.name}</span>
                    <span class="item-cat">${r.category || 'Uncategorized'}</span>
                </div>
            `).join('');
            dropdown.classList.remove('view-hidden');
        } else {
            dropdown.innerHTML = '<div class="search-item">No recipes found</div>';
            dropdown.classList.remove('view-hidden');
        }
    }

    function selectSearchResult(recipeId, category) {
        currentCategory = category;
        loadRecipe(recipeId);
        document.getElementById('recipe-search').value = '';
        document.getElementById('search-dropdown').classList.add('view-hidden');
    }

    document.addEventListener('click', (e) => {
        if (!e.target.closest('.search-container')) {
            document.getElementById('search-dropdown').classList.add('view-hidden');
        }
    });

    function showHome() {
        document.getElementById('home-view').classList.remove('view-hidden');
        document.getElementById('category-view').classList.add('view-hidden');
        document.getElementById('calc-view').classList.add('view-hidden');
        updateNav("home");
        window.scrollTo(0,0);
    }

    function loadCategory(cat) {
        currentCategory = cat;
        const list = document.getElementById('recipe-list');
        list.innerHTML = '';
        document.getElementById('cat-title').innerText = cat;

        const filteredRecipes = recipes.filter(r => (r.category || "Uncategorized") === cat);

        filteredRecipes.forEach(r => {
            const card = document.createElement('div');
            card.className = 'card-base recipe-card';
            card.innerHTML = `<div class="recipe-card-content"><h3>${r.name}</h3><p>${r.desc}</p></div>`;
            card.onclick = () => loadRecipe(r.id);
            list.appendChild(card);
        });

        document.getElementById('home-view').classList.add('view-hidden');
        document.getElementById('category-view').classList.remove('view-hidden');
        document.getElementById('calc-view').classList.add('view-hidden');
        updateNav("category");
        window.scrollTo(0,0);
    }

    function loadRecipe(id) {
        currentRecipe = recipes.find(r => r.id === id);
        currentBatchScale = 1.0;
        
        document.getElementById('home-view').classList.add('view-hidden');
        document.getElementById('category-view').classList.add('view-hidden');
        document.getElementById('calc-view').classList.remove('view-hidden');
        
        document.getElementById('recipe-name').innerText = currentRecipe.name;
        document.getElementById('recipe-desc').innerText = currentRecipe.desc;
        document.getElementById('method-text').innerText = currentRecipe.method;
        document.getElementById('batch-val').innerText = currentBatchScale.toFixed(1);
        
        const pizzaControls = document.getElementById('pizza-controls');
        const standardControls = document.getElementById('standard-controls');

        if (currentRecipe.type === 'pizza') {
            pizzaControls.style.display = '';
            standardControls.style.display = 'none';
        } else {
            pizzaControls.style.display = 'none';
            standardControls.style.display = '';
        }
        
        const linkCont = document.getElementById('recipe-link-container');
        linkCont.innerHTML = currentRecipe.linkTo ? `<button class="link-btn" onclick="loadRecipe('${currentRecipe.linkTo}')">${currentRecipe.linkText}</button>` : '';
        
        renderPans();
        updateNav("recipe");
        window.scrollTo(0,0);
    }

    function updateNav(view) {
        const nav = document.getElementById('nav-container');
        nav.innerHTML = '';

        if (view === "category") {
            nav.innerHTML = `<button class="nav-btn" onclick="showHome()">← Home</button>`;
        } else if (view === "recipe") {
            nav.innerHTML = `
                <button class="nav-btn" onclick="loadCategory('${currentCategory}')">← Back to ${currentCategory}</button>
                <button class="nav-btn" onclick="showHome()">⌂ Home</button>
            `;
        }
    }

    function formatFraction(num) {
        if (num <= 0) return "";
        const whole = Math.floor(num);
        let fraction = num - whole;
        let fStr = "";
        
        if (Math.abs(fraction - 0.33) < 0.05 || Math.abs(fraction - 0.333) < 0.05) fStr = "⅓";
        else if (Math.abs(fraction - 0.66) < 0.05 || Math.abs(fraction - 0.666) < 0.05) fStr = "⅔";
        else if (fraction >= 0.875) return (whole + 1).toString();
        else if (fraction >= 0.625) fStr = "¾";
        else if (fraction >= 0.375) fStr = "½";
        else if (fraction >= 0.125) fStr = "¼";
        
        return (whole > 0 ? (fStr ? whole + " " : whole) : "") + fStr;
    }

    function getVolumetric(scaledValue, ing) {
        if (ing.isQty) {
            let val = Math.round(scaledValue * 10) / 10;
            return val + " " + (ing.name || "Item") + (val !== 1 ? "s" : ""); 
        }
        if (ing.isChicken) return (scaledValue / 454).toFixed(2) + " lbs";

        let cleanName = ing.name.toLowerCase();
        let d = 125; 
        if (cleanName in densities) d = densities[cleanName];

        if (cleanName === "sugar" && currentRecipe.id === "avantis-bread") {
            let scale = scaledValue / 134; 
            let thirds = (scale * 2);
            return formatFraction(thirds/3) + " cup";
        }

        let totalTsp = 0;
        if (teaspoonIngredients.includes(cleanName)) {
            totalTsp = (scaledValue / d);
        } else {
            totalTsp = (scaledValue / d) * 48; 
        }

        const standardFractions = [0.25, 0.333, 0.5, 0.666, 0.75, 1.0];
        if (!teaspoonIngredients.includes(cleanName)) {
            for (let frac of standardFractions) {
                let targetGrams = d * frac;
                if (Math.abs(scaledValue - targetGrams) <= 2) {
                    totalTsp = (targetGrams / d) * 48;
                    break;
                }
            }
        }

        if (totalTsp >= 11.5) { 
            let totalCups = totalTsp / 48;
            let wholeCups = Math.floor(totalCups);
            let remTsp = (totalCups - wholeCups) * 48;
            
            if (Math.abs(remTsp - 16) < 1.5) return (wholeCups > 0 ? wholeCups + " " : "") + "⅓ cup";
            else if (Math.abs(remTsp - 32) < 1.5) return (wholeCups > 0 ? wholeCups + " " : "") + "⅔ cup";

            let cupFracValue = (Math.floor(remTsp / 12) * 0.25);
            let cupFracStr = formatFraction(cupFracValue);
            let extraTbsp = Math.round((remTsp % 12) / 3);
            
            if (extraTbsp === 4) {
                extraTbsp = 0;
                cupFracValue += 0.25;
                if (cupFracValue === 1) { wholeCups++; cupFracValue = 0; }
                cupFracStr = formatFraction(cupFracValue);
            }

            let res = [];
            if (wholeCups > 0 || cupFracValue > 0) res.push((wholeCups > 0 ? wholeCups : "") + (cupFracStr ? " " + cupFracStr : "") + " cup");
            if (extraTbsp > 0) res.push(extraTbsp + " tbsp");
            return res.length > 0 ? res.join(" + ") : "0 tsp";

        } else if (totalTsp >= 3) {
            let tbsp = Math.floor(totalTsp / 3);
            let tsp = Math.round((totalTsp % 3) * 4) / 4;
            let res = [tbsp + " tbsp"];
            if (tsp > 0) res.push(formatFraction(tsp) + " tsp");
            return res.join(" + ");
        } else {
            return formatFraction(Math.round(totalTsp * 4) / 4) + " tsp";
        }
    }

    function changeBatch(delta) {
        currentBatchScale = Math.max(0.5, currentBatchScale + delta);
        document.getElementById('batch-val').innerText = currentBatchScale.toFixed(1);
        calculate();
    }

    function addPan() {
        pans.push({ id: Date.now(), shape: 'rect', dim1: 10, dim2: 8, qty: 1 });
        renderPans();
    }
    
    function renderPans() {
        const container = document.getElementById('pan-container');
        container.innerHTML = '';
        pans.forEach(pan => {
            const div = document.createElement('div');
            div.className = 'pan-row';
            div.innerHTML = `
                <div class="pan-field"><label>Shape</label><select onchange="const p=pans.find(x=>x.id===${pan.id}); p.shape=this.value; renderPans();"><option value="rect" ${pan.shape === 'rect' ? 'selected' : ''}>Rectangle</option><option value="circle" ${pan.shape === 'circle' ? 'selected' : ''}>Circle</option></select></div>
                <div class="pan-field"><label>${pan.shape === 'rect' ? 'Length' : 'Diameter'}</label><input type="number" value="${pan.dim1}" oninput="const p=pans.find(x=>x.id===${pan.id}); p.dim1=parseFloat(this.value)||0; calculate();"></div>
                <div class="pan-field ${pan.shape === 'circle' ? 'view-hidden' : ''}"><label>Width</label><input type="number" value="${pan.dim2}" oninput="const p=pans.find(x=>x.id===${pan.id}); p.dim2=parseFloat(this.value)||0; calculate();"></div>
                <div class="pan-field" style="flex:0.5; min-width:60px;"><label>Qty</label><input type="number" value="${pan.qty}" oninput="const p=pans.find(x=>x.id===${pan.id}); p.qty=parseFloat(this.value)||0; calculate();"></div>
                <button class="remove-btn" onclick="pans=pans.filter(p=>p.id!==${pan.id}); renderPans();">REMOVE</button>
            `;
            container.appendChild(div);
        });
        calculate();
    }

    function calculate() {
        if (!currentRecipe) return;
        let factor = (currentRecipe.type === 'pizza') ? 
            (pans.reduce((sum, p) => sum + (p.qty * (p.shape === 'rect' ? p.dim1*p.dim2 : Math.PI*Math.pow(p.dim1/2,2))), 0) / currentRecipe.baseArea) : 
            currentBatchScale;
        document.getElementById('factor-display').innerText = factor.toFixed(2) + "x";
        const isFresh = document.getElementById('isFreshMilled').checked;
        const tbody = document.getElementById('ingredient-body');
        tbody.innerHTML = '';
        let totalW = 0;
        currentRecipe.ingredients.forEach(ing => {
            let sW = ing.val * factor;
            if (isFresh && (ing.isLiquid || ing.isChicken)) sW *= 1.05;
            if (!ing.isQty) totalW += sW;

            let gramsDisplay = ing.isQty ? (sW.toFixed(1) + " " +ing.name) : (sW.toFixed(1) + "g");
            tbody.innerHTML += `<tr><td>${ing.name}</td><td><strong>${gramsDisplay}</strong></td><td>${getVolumetric(sW, ing)}</td></tr>`;
        });
        document.getElementById('grand-total').innerText = Math.round(totalW);
    }
    window.onload = init;
</script>
</body>
</html>